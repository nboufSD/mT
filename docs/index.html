<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://miro.com/app/static/sdk.1.1.js"></script>
    <canvas width="300" height="150" id="sample" style="background-color:yellow;"></canvas>
    <script>
    let allStickers;
    let boardId;
    let maxTimestamp = 0;
    let users;
    const tempUsersLength = [];
    let tempUsers;
    let initUnixtime;
    let usersIds;

    miro.onReady(() => {
      miro.addListener('WIDGETS_CREATED', widget => {
          console.log(widget)
        })
      miro.initialize({
        extensionPoints: {
          bottomBar: {
            title: 'Some title',
            svgIcon: '<circle cx="12" cy="12" r="9" fill="none" fill-rule="evenodd" stroke="currentColor" stroke-width="2"/>',
            onClick: () => {
              console.log(miro.board.info.get());
              miro.board.info.get().then((board) =>{
                console.log('boardId', board.id);
                boardId = board.id;
                console.log("maxTimestamp");
                console.log(maxTimestamp);
                console.log("URL");
                console.log("https://asia-northeast1-comado-12e38.cloudfunctions.net/getRecords?time=" + maxTimestamp + '' + "&boardId=" + boardId);
                fetch("https://asia-northeast1-comado-12e38.cloudfunctions.net/getRecords?time=" + maxTimestamp + '' + "&boardId=" + boardId)
                  .then((response) => {
                      return response.json();　//ここでBodyからJSONを返す
                  })
                  .then((result) => {
                      Example(result);  //取得したJSONデータを関数に渡す
                  })
                  .catch((e) => {
                      console.log(e);  //エラーをキャッチし表示
                  })
              })
              // fetch("https://nboufsd.github.io/mT/json/sample.json")
            }
          }
        }
      })
    })

    function Example(response){
      // const users = response["userInfo"];

      if (!users){
        users = response;
      } else {
        users = users.concat(response);
        console.log(users);
      }
      console.log(users);

      usersIds = users.map(function(user) {
        return user.peerId;
      });

      const kindOfusers = users.filter(function(user, index) {
        return usersIds.indexOf(user.peerId) === index;
      });

      for (let i = 0; i < kindOfusers.length; i++) {
        miro.board.widgets.create({
          type: 'text',
          text: kindOfusers[i]["nickname"],
          x: 0,
          y: 0 + 350 * i,
        })
        // miro.board.widgets.create({
        //   type: "image",
        //   url: kindOfusers[i]["userPhoto"],
        //   x: 100,
        //   y: 0 + 350 * i
        // })
      }

      // console.log(kindOfusers);


      if (!maxTimestamp) {
        initUnixtime = users[0]["time"];
      }
      const allStickers = miro.board.widgets.get({type: 'image'})
      console.log("allStickers");
      console.log(allStickers);
      maxTimestamp = Math.max.apply(null,users.map(x => x.time));
      const intervalTime = maxTimestamp - initUnixtime;
      console.log(maxTimestamp);
      console.log(intervalTime);

      let dateTime;
      let unixtime;
      for (let i = 0; i < intervalTime / 600000 ; i++) {
        // unixtime = initUnixtime + Math.floor(intervalTime * i);
        unixtime = initUnixtime /1000 + Math.floor(600 * i);
        dateTime = new Date(unixtime / 1000);
        miro.board.widgets.create({
          type: 'text',
          width: 55,
          x: 210 + 50 + 600 * i,
          y: -100,
          // y: (( i + 2 ) % 2) === 0 ? -150 : -100,
          // style: {
            // allowed values: "center", "right", "left"
          //   textAlign: "right", // default: "center"
          // },
          text: dateTime.toLocaleTimeString().substr( 0, 5 ) + '',
        })
      }

      for (let i = 0; i < kindOfusers.length; i++) {
        tempUsers = users.filter(user =>
          user.peerId === kindOfusers[i].peerId
        );
        for (let j = 0; j < tempUsers.length; j++) {
          if (tempUsersLength[i] > j) {
            console.log(tempUsersLength);
            console.log(j);
            continue;
          }
          miro.board.widgets.create({
            type: "image",
            url: tempUsers[j]["image"],
            x: 210 + 50 + Number((tempUsers[j]["time"] - initUnixtime) / 1000) ,
            y: 0 + 350 * i,
            scale: 0.2,
            // metadata: {
            //   "sample": {
            //     "time": tempUsers[j]["time"]
            //   }
            // },
          })
          // console.log(new Date(tempUsers[j]["time"]));
          console.log(tempUsersLength);
          console.log(tempUsers);
          // miro.board.widgets.create({
          //   type: 'sticker',
          //   text: tempUsers[j]["message"],
          //   x: 210 + 50 + Number(tempUsers[j]["time"] - initUnixtime),
          //   y: 70 + 150 * i,
          //   scale: 0.2,
          //   style: {
          //     stickerBackgroundColor: tempUsers[j]["messageColor"],
          //   }
          // })
          tempUsersLength[i] = (tempUsers.length);
        }
      }
    }
    </script>
</head>
<body>
  <img src = "images/1.png">
  <img src = "images/2.png">
  <img src = "images/3.png">
  <img src = "images/4.png">
  <img src = "images/5.png">
  <img src = "images/6.png">
  <img src = "images/7.png">
  <img src = "images/8.png">
  <img src = "images/9.png">
  <img src = "images/A.png">
  <img src = "images/B.png">
  <img src = "images/C.png">
  HELLO WORLD
</body>
</html>