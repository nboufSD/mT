<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://miro.com/app/static/sdk.1.1.js"></script>
    <canvas width="300" height="150" id="sample" style="background-color:yellow;"></canvas>
    <script>
    let allStickers;

    miro.onReady(() => {
      // console.log(context);
      miro.addListener('WIDGETS_CREATED', widget => {
          console.log(widget)
        })
      miro.initialize({
        extensionPoints: {
          bottomBar: {
            title: 'Some title',
            svgIcon: '<circle cx="12" cy="12" r="9" fill="none" fill-rule="evenodd" stroke="currentColor" stroke-width="2"/>',
            onClick: () => {
              // miro.board.widgets.create({type: 'sticker', text: 'https://nboufsd.github.io/mT/json/sample.json'})
              // const url = value[0]["text"];
              fetch("https://nboufsd.github.io/mT/json/sample.json")
                .then((response) => {
                    return response.json();　//ここでBodyからJSONを返す
                })
                .then((result) => {
                    Example(result);  //取得したJSONデータを関数に渡す
                })
                .catch((e) => {
                    console.log(e);  //エラーをキャッチし表示
                })
            }
          }
        }
      })
      // ボタンをトリガーにする
      // miro.addListener('WIDGETS_CREATED', widget => {
      //   allStickers = miro.board.widgets.get({type: 'STICKER'})
      //   allStickers.then((value) => {
          // 読み込むURLは決定している
          // JSONは配列にしておき、全てのウィジェットに対するJSONを全てリストとして読みとる
          // そのリストの最後のidをサーバーに返して、サーバーはそのid以降を次回から渡す（後日）

          // fetchをXMLHttpRequestの代わりに使う
          // let req = new XMLHttpRequest();		  // XMLHttpRequest オブジェクトを生成する
          //     req.open("GET", value[0]["text"]); // HTTPメソッドとアクセスするサーバーの　URL　を指定
          //     req.send(null);

          //     req.onreadystatechange = function() {		  // XMLHttpRequest オブジェクトの状態が変化した際に呼び出されるイベントハンドラ
          //       if(req.readyState == 4 && req.status == 200){

          //         let response = this.response;
          //         if (typeof response === "string") {
          //           response = JSON.parse(response);
          //         }

          //         console.log(response["imageUrl"]);
          //         miro.board.widgets.create({
          //           type: "image",
          //           url: response["imageUrl"],
          //           x: 0,
          //           y: 0
          //         })
          //         miro.board.widgets.deleteById(value[0]["id"])
          //       }
          //     };
      //   });
      //   console.log(allStickers);
      //   console.log(widget);
      //   alert('FINED OUT IMAGES')
      // })
    })

    function Example(response){
      const users = response["userInfo"];

      users.sort(function(a, b) {
        return a.timeStamp - b.timeStamp;
      });
      console.log(users);

      const usersIds = users.map(function(user) {
        return user.userId;
      });

      const kindOfusers = users.filter(function(user, index) {
        return usersIds.indexOf(user.userId) === index;
      });

      for (let i = 0; i < kindOfusers.length; i++) {
        miro.board.widgets.create({
          type: 'text',
          text: kindOfusers[i]["userName"],
          x: 0,
          y: 0 + 150 * i,
        })
        miro.board.widgets.create({
          type: "image",
          url: kindOfusers[i]["userPhoto"],
          x: 100,
          y: 0 + 150 * i
        })
      }

      let tempUsers;
      const initUnixtime = 1616321772;
      const maxTimestamp = Math.max.apply(null,users.map(x => x.timeStamp));
      const intervalTime = ( maxTimestamp - initUnixtime ) / 30;
      console.log(maxTimestamp);

      for (let i = 0; i < 30; i++) {
        miro.board.widgets.create({
          type: 'text',
          width: 100,
          text: intervalTime * i + '',
          x: 210 + 30 + intervalTime * i,
          y: -100,
        })
      }

      for (let i = 0; i < kindOfusers.length; i++) {
        tempUsers = users.filter(user =>
          user.userId === kindOfusers[i].userId
        );
        for (let j = 0; j < tempUsers.length; j++) {
          miro.board.widgets.create({
            type: "image",
            url: tempUsers[j]["imageUrl"],
            x: 210 + (Number(tempUsers[j]["timeStamp"] - initUnixtime) / Number( maxTimestamp - initUnixtime )) * intervalTime,
            y: 0 + 150 * i,
          })
          miro.board.widgets.create({
            type: 'sticker',
            text: tempUsers[j]["message"],
            x: 210 + (Number(tempUsers[j]["timeStamp"] - initUnixtime) / Number( maxTimestamp - initUnixtime )) * intervalTime,
            y: 70 + 150 * i,
            scale: 0.2,
            style: {
              "backgroundColor": tempUsers[j]["messageColor"],
            }
          })
          // console.log(210 + Number(tempUsers[j]["timeStamp"] - initUnixtime));
          // miro.addListener('WIDGETS_CREATED', widget => {
          //   allStickers = miro.board.widgets.get({type: 'STICKER'});
          //   console.log(allStickers);
          // })
        }
      }

      // miro.board.widgets.deleteById(value[0]["id"])
    }
    </script>
</head>
<body>
  <img src = "images/11.png">
  <img src = "images/12.png">
  <img src = "images/13.png">
  <img src = "images/14.png">
  <img src = "images/15.png">
  <img src = "images/16.png">
  <img src = "images/17.png">
  <img src = "images/18.png">
  <img src = "images/19.png">
  <img src = "images/1A.png">
  <img src = "images/1B.png">
  <img src = "images/1C.png">
  HELLO WORLD
</body>
</html>